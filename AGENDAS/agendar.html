<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agendar Sala</title>
<link rel="stylesheet" href="login.css">
<style>
/* Estilos para diferenciar status dos hor치rios */
.ocupado { background-color: #ff9999; }   /* Vermelho claro: sala ocupada */
.meu { background-color: #99ffb3; }       /* Verde claro: reserva do pr칩prio usu치rio */
.livre { background-color: #e6e6e6; cursor: pointer; } /* Cinza: dispon칤vel para reservar */
.livre:hover { background-color: #cce5ff; } /* Azul claro ao passar o mouse */

/* Estilos da tabela */
table {border-collapse: collapse; width: 100%; margin-top: 20px;}
th, td {border: 1px solid #ccc; padding: 8px; text-align: center;}
th {background-color: #f4f4f4;}
</style>
</head>

<body>
<header>
    <h1>Agendamento de Salas</h1>
</header>

<main>
<div class="login-container">
<h2>Nova Reserva</h2>

<!-- Formul치rio para reservar sala -->
<form method="POST" action="agendar.php" id="formAgendar">
    <label for="sala">Sala:</label>
    <select name="id_sala" id="sala" required>
        <option value="">Selecione uma sala</option>
        <option value="1">Laborat칩rio de Inform치tica 1</option>
        <option value="2">Laborat칩rio de Inform치tica 2</option>
        <option value="3">Oficina de Eletr칪nica</option>
        <option value="4">Audit칩rio</option>
    </select><br>

    <label for="data">Data da Reserva:</label>
    <input type="date" name="data_reserva" id="data" required><br>

    <!-- Inputs ocultos: preenchidos automaticamente ao escolher um hor치rio -->
    <input type="hidden" name="hora_inicio" id="hora_inicio">
    <input type="hidden" name="hora_fim" id="hora_fim">

    <button type="submit">Agendar Sala</button>
</form>

<!-- Tabela que exibe os hor치rios dispon칤veis e ocupados -->
<h3>游늰 Hor치rios do Dia</h3>
<table id="tabelaHorarios">
<tr>
    <th>Hor치rio</th>
    <th>Status</th>
    <th>Usu치rio</th>
</tr>
</table>
</div>
</main>

<script>
// Lista de feriados fixos
const feriados = ["2025-01-01", "2025-04-21", "2025-05-01", "2025-09-07", "2025-10-12", "2025-11-02", "2025-11-15", "2025-12-25"];

const sala = document.getElementById('sala');
const data = document.getElementById('data');
const tabela = document.getElementById('tabelaHorarios');

// Bloqueia finais de semana e feriados
data.addEventListener("input", function() {
    const d = new Date(this.value);
    const diaSemana = d.getDay(); // 0 = domingo, 6 = s치bado
    if (diaSemana === 0 || diaSemana === 6 || feriados.includes(this.value)) {
        alert("N칚o 칠 permitido reservar finais de semana ou feriados!");
        this.value = "";
        tabela.innerHTML = "<tr><th>Hor치rio</th><th>Status</th><th>Usu치rio</th></tr>";
    }
});

// Fun칞칚o para buscar os hor치rios do dia no servidor
async function atualizarHorarios() {
    if(!sala.value || !data.value) return;

    // Chama o PHP que retorna os hor치rios em JSON
    const response = await fetch(`ver_horarios_json.php?id_sala=${sala.value}&data_reserva=${data.value}`);
    const horarios = await response.json();

    // Monta a tabela novamente
    tabela.innerHTML = "<tr><th>Hor치rio</th><th>Status</th><th>Usu치rio</th></tr>";
    horarios.forEach(h => {
    const tr = document.createElement('tr');

    const tdHora = document.createElement('td');
    tdHora.textContent = h.hora;

    const tdStatus = document.createElement('td');
    tdStatus.textContent = h.status;
    tdStatus.className = h.class;

    const tdUsuario = document.createElement('td');
    tdUsuario.textContent = h.usuario;

        // Se estiver livre -> permite clicar
    if (h.class === "livre") {
        tr.classList.add("livre");
        tr.addEventListener("click", () => {
        document.getElementById("hora_inicio").value = h.hora;

                // Calcula hora final (30 minutos depois do in칤cio)
        const [h1, m1] = h.hora.split(":").map(Number);
        const fim = new Date(0,0,0,h1,m1+30);
        document.getElementById("hora_fim").value = fim.toTimeString().substring(0,5);

        alert(`Voc칡 selecionou: ${h.hora} - ${document.getElementById("hora_fim").value}`);
        });
        }

        tr.appendChild(tdHora);
        tr.appendChild(tdStatus);
        tr.appendChild(tdUsuario);
        tabela.appendChild(tr);
    });
}

// Atualiza a tabela quando mudar a sala ou a data
sala.addEventListener('change', atualizarHorarios);
data.addEventListener('change', atualizarHorarios);
</script>

</body>
</html>
