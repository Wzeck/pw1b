<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agendar Sala</title>

<!-- usa o mesmo CSS do login/cadastro -->
<link rel="stylesheet" href="login.css">

<style>
/* ajustes visuais espec칤ficos da p치gina (mantendo o mesmo estilo) */
main { flex: 1; display:flex; justify-content:center; align-items:flex-start; padding:40px 0; }
.agendar-container {
    background:#fff;
    border-radius:16px;
    box-shadow:0 10px 35px rgba(0,0,0,0.1);
    padding:40px;
    width:950px;
    display:flex;
    gap:30px;
    flex-wrap:wrap;
}
.agendar-container h2 { width:100%; color:#2c3e50; margin-bottom:10px; }

/* form */
.form-section, .tabela-section { flex:1; min-width:380px; }
.form-section label { display:block; margin:15px 0 6px; font-weight:600; color:#2c3e50; }
.form-section select, .form-section input[type="date"] {
    width:100%; padding:12px; border-radius:8px; border:1px solid #bdc3c7; background:#ecf0f1; font-size:14px;
    transition: border-color .3s, background .3s;
}
.form-section select:focus, .form-section input[type="date"]:focus { border-color:#2980b9; background:#fff; outline:none; }
.form-section button { margin-top:20px; }

/* tabela */
.tabela-section table { width:100%; border-collapse:collapse; border-radius:10px; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
.tabela-section th { background:#2980b9; color:#fff; padding:12px; text-transform:uppercase; font-size:14px; }
.tabela-section td { padding:12px; text-align:center; border-bottom:1px solid #ecf0f1; }
.tabela-section tr.livre { background:#e8f6ff; cursor:pointer; transition:background .2s; }
.tabela-section tr.livre:hover { background:#d6ebff; }
.tabela-section tr.ocupado { background:#f8d7da; color:#721c24; }
.tabela-section tr.meu { background:#d4edda; color:#155724; font-weight:600; }
.tabela-section tr.selecionado { background:#ffe58f !important; font-weight:bold; }

/* toast */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  min-width: 260px;
  padding: 14px 16px;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  color: #fff;
  font-weight:600;
  display: none;
  z-index: 9999;
}
.toast.show { display:block; animation: toastIn .25s ease; }
@keyframes toastIn { from { transform: translateY(-10px); opacity:0 } to { transform: translateY(0); opacity:1 } }
.toast.success { background: linear-gradient(90deg,#2ecc71,#27ae60); }
.toast.error { background: linear-gradient(90deg,#ff6b6b,#e74c3c); }

/* bot칚o desabilitado */
button[disabled] { opacity: 0.6; cursor: not-allowed; transform: none !important; }

/* responsivo */
@media (max-width: 980px) {
  .agendar-container { width: 92%; padding: 24px; }
}
</style>
</head>
<body>

<header>
  <div class="header-content">
    <h1>Agenda ETEC</h1>
    <nav>
      <a href="login.html">Login</a>
      <a href="cadastro.html">Cadastro</a>
      <a href="agendar.html" class="active">Agendar</a>
    </nav>
  </div>
</header>

<main>
  <div class="agendar-container">
    <h2>Agendar Sala</h2>

    <!-- FORM -->
    <div class="form-section">
      <form id="formAgendar" autocomplete="off">
        <label for="sala">Sala:</label>
        <select id="sala" name="id_sala" required>
          <option value="">Selecione uma sala</option>
          <option value="1">Laborat칩rio de Inform치tica 1</option>
          <option value="2">Laborat칩rio de Inform치tica 2</option>
          <option value="3">Oficina de Eletr칪nica</option>
          <option value="4">Audit칩rio</option>
        </select>

        <label for="data">Data da Reserva:</label>
        <input id="data" name="data_reserva" type="date" required />

        <label for="horario_selecionado">Hor치rio:</label>
        <select id="horario_selecionado" name="horario_selecionado" disabled required>
          <option value="">Selecione data e sala</option>
        </select>

        <!-- campos ocultos que s칚o enviados ao agendar.php -->
        <input type="hidden" id="hora_inicio" name="hora_inicio">
        <input type="hidden" id="hora_fim" name="hora_fim">

        <button id="btnAgendar" type="submit">Agendar Sala</button>
      </form>
    </div>

    <!-- TABELA -->
    <div class="tabela-section">
      <h3>游늰 Hor치rios do Dia</h3>
      <table id="tabelaHorarios">
        <tr>
          <th>Hor치rio</th>
          <th>Status</th>
          <th>Usu치rio</th>
        </tr>
      </table>
    </div>
  </div>
</main>

<footer>
  
</footer>

<!-- toast -->
<div id="toast" class="toast"></div>

<script>
/* ===== elementos ===== */
const sala = document.getElementById('sala');
const dataInput = document.getElementById('data');
const tabela = document.getElementById('tabelaHorarios');
const selectHorario = document.getElementById('horario_selecionado');
const hiddenInicio = document.getElementById('hora_inicio');
const hiddenFim = document.getElementById('hora_fim');
const form = document.getElementById('formAgendar');
const btnAgendar = document.getElementById('btnAgendar');
const toast = document.getElementById('toast');

/* mostra toast */
function showToast(type, text, timeout = 3000) {
  toast.className = `toast show ${type === 'ok' ? 'success' : 'error'}`;
  toast.textContent = text;
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => {
    toast.classList.remove('show');
  }, timeout);
}

/* busca hor치rios do servidor e popula tabela + select */
async function atualizarHorarios() {
  if (!sala.value || !dataInput.value) {
    tabela.innerHTML = '<tr><th>Hor치rio</th><th>Status</th><th>Usu치rio</th></tr>';
    selectHorario.innerHTML = '<option value="">Selecione data e sala</option>';
    selectHorario.disabled = true;
    return;
  }

  selectHorario.innerHTML = '<option value="">Carregando...</option>';
  selectHorario.disabled = true;
  tabela.innerHTML = '<tr><th>Hor치rio</th><th>Status</th><th>Usu치rio</th></tr>';

  try {
    const res = await fetch(`ver_horarios_json.php?id_sala=${encodeURIComponent(sala.value)}&data_reserva=${encodeURIComponent(dataInput.value)}`, {cache: "no-store"});
    if (!res.ok) throw new Error('Erro na resposta');
    const horarios = await res.json();

    const livres = [];

    horarios.forEach(h => {
      const tr = document.createElement('tr');
      tr.className = h.class || '';
      tr.innerHTML = `<td>${h.hora}</td><td>${h.status}</td><td>${h.usuario || '-'}</td>`;
      tabela.appendChild(tr);

      if (h.class === 'livre') {
        livres.push(h.hora);
        // clique visual na linha
        tr.addEventListener('click', () => selecionarHorario(h.hora, tr));
      }
    });

    // popula o select com hor치rios livres
    selectHorario.innerHTML = '<option value="">Selecione um hor치rio</option>';
    if (livres.length > 0) {
      livres.forEach(hora => {
        const opt = document.createElement('option');
        opt.value = hora;
        opt.textContent = hora;
        selectHorario.appendChild(opt);
      });
      selectHorario.disabled = false;
    } else {
      selectHorario.disabled = true;
    }

  } catch (err) {
    console.error(err);
    tabela.innerHTML = '<tr><td colspan="3">Erro ao carregar hor치rios.</td></tr>';
    selectHorario.innerHTML = '<option value="">Erro</option>';
    selectHorario.disabled = true;
  }
}

/* seleciona hor치rio (tanto por click quanto por select) */
function selecionarHorario(hora, trElement = null) {
  // calcula hora fim (+30 min)
  const [H, M] = hora.split(':').map(Number);
  const dt = new Date(0,0,0,H,M+30);
  const horaFim = dt.toTimeString().slice(0,5);

  hiddenInicio.value = hora;
  hiddenFim.value = horaFim;

  // visual
  document.querySelectorAll('#tabelaHorarios tr').forEach(r => r.classList.remove('selecionado'));
  if (trElement) trElement.classList.add('selecionado');

  // sincroniza select
  selectHorario.value = hora;
}

/* quando muda selectHorario via dropdown */
selectHorario.addEventListener('change', function() {
  const hora = this.value;
  if (!hora) {
    hiddenInicio.value = '';
    hiddenFim.value = '';
    document.querySelectorAll('#tabelaHorarios tr').forEach(r => r.classList.remove('selecionado'));
    return;
  }
  // procura a linha correspondente
  const linhas = Array.from(document.querySelectorAll('#tabelaHorarios tr.livre'));
  const alvo = linhas.find(tr => tr.children[0].textContent === hora);
  selecionarHorario(hora, alvo || null);
});

/* eventos para atualizar hor치rios ao mudar sala/data */
sala.addEventListener('change', atualizarHorarios);
dataInput.addEventListener('change', atualizarHorarios);

/* envio via AJAX (fetch) */
form.addEventListener('submit', async function(e) {
  e.preventDefault();

  // valida campos b치sicos
  if (!sala.value || !dataInput.value || !hiddenInicio.value || !hiddenFim.value) {
    showToast('erro', 'Selecione sala, data e hor치rio antes de agendar.');
    return;
  }

  btnAgendar.disabled = true;
  btnAgendar.textContent = 'Enviando...';

  try {
    const formData = new FormData(form);
    // envia para agendar.php (retorna JSON)
    const res = await fetch('agendar.php', { method: 'POST', body: formData });
    if (!res.ok) throw new Error('Erro na requisi칞칚o');

    const json = await res.json();
    if (json.status === 'ok') {
      showToast('ok', json.mensagem || 'Reserva realizada com sucesso!');
      // limpa sele칞칚o vis칤vel
      document.querySelectorAll('#tabelaHorarios tr').forEach(r => r.classList.remove('selecionado'));
      hiddenInicio.value = '';
      hiddenFim.value = '';
      selectHorario.value = '';
      // atualiza tabela para refletir nova reserva
      await atualizarHorarios();
    } else {
      showToast('erro', json.mensagem || 'Erro ao agendar.');
    }
  } catch (err) {
    console.error(err);
    showToast('erro', 'Erro de rede. Tente novamente.');
  } finally {
    btnAgendar.disabled = false;
    btnAgendar.textContent = 'Agendar Sala';
  }
});

/* inicializa a tabela vazia na carga */
document.addEventListener('DOMContentLoaded', () => {
  tabela.innerHTML = `
    <tr><th>Hor치rio</th><th>Status</th><th>Usu치rio</th></tr>
    <tr><td colspan="3">Selecione sala e data para ver os hor치rios.</td></tr>
  `;
});
</script>
</body>
</html>
